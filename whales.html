<!DOCTYPE html>
<html>
<head>
  <title>Whale Song Visualizer</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: "Courier New", monospace;
    }
    canvas {
      width: 100vw;
      height: 100vh;
      display: block;
      background: linear-gradient(#0f172a, #1e3a8a);
    }
    #controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 10;
    }
    button {
      font-size: 16px;
      padding: 6px 12px;
    }
    #whale {
      position: absolute;
      top: 20%;
      left: -20%;
      width: 200px;
      height: auto;
      fill: white;
      opacity: 0;
      pointer-events: none;
      z-index: 5;
    }
  </style>
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.module.js';
    import { animate } from 'https://cdn.jsdelivr.net/npm/motion/dist/motion.es.js';

    let scene, camera, renderer, analyser, dataArray, bars = [],
        audioCtx, oscillator, gainNode, lfo, isPlaying = false;
    const numBars = 64;

    function initThree() {
      const canvas = document.getElementById('scene');
      renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 10, 30);
      camera.lookAt(0, 0, 0);

      const planeGeo = new THREE.PlaneGeometry(numBars, 10, numBars - 1, 1);
      const planeMat = new THREE.MeshBasicMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.3, side: THREE.DoubleSide, wireframe: true });
      const wave = new THREE.Mesh(planeGeo, planeMat);
      wave.rotation.x = -Math.PI / 2;
      scene.add(wave);

      const barGeo = new THREE.BoxGeometry(0.5, 1, 0.5);
      for (let i = 0; i < numBars; i++) {
        const mat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.6 });
        const bar = new THREE.Mesh(barGeo, mat);
        bar.position.x = i - numBars / 2 + 0.25;
        scene.add(bar);
        bars.push(bar);
      }

      window.addEventListener('resize', () => {
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      });
    }

    function initAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = numBars * 2;
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      oscillator = audioCtx.createOscillator();
      oscillator.type = 'sine';
      oscillator.frequency.value = 200;

      lfo = audioCtx.createOscillator();
      lfo.frequency.value = 0.2;
      const lfoGain = audioCtx.createGain();
      lfoGain.gain.value = 150;
      lfo.connect(lfoGain);
      lfoGain.connect(oscillator.frequency);

      gainNode = audioCtx.createGain();
      gainNode.gain.value = 0;

      oscillator.connect(gainNode);
      gainNode.connect(analyser);
      analyser.connect(audioCtx.destination);

      oscillator.start();
      lfo.start();
    }

    function render() {
      requestAnimationFrame(render);
      if (analyser) {
        analyser.getByteFrequencyData(dataArray);
        const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length / 255;
        document.getElementById('whale').style.opacity = avg.toString();
        for (let i = 0; i < bars.length; i++) {
          const val = dataArray[i] / 255 * 8 + 0.1;
          bars[i].scale.y = val;
          bars[i].position.y = val / 2;
        }
      }
      renderer.render(scene, camera);
    }

    function setupWhale() {
      const whale = document.getElementById('whale');
      animate(whale, { x: ['-20%', '120%'] }, { duration: 20, easing: 'linear', repeat: Infinity });
    }

    function togglePlay() {
      if (!isPlaying) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        gainNode.gain.setTargetAtTime(0.5, audioCtx.currentTime, 0.01);
        isPlaying = true;
        document.getElementById('playPause').textContent = 'Pause';
      } else {
        gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.01);
        isPlaying = false;
        document.getElementById('playPause').textContent = 'Play';
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      initThree();
      initAudio();
      setupWhale();
      render();
      document.getElementById('playPause').addEventListener('click', togglePlay);
      document.addEventListener('keydown', e => {
        if (e.code === 'Space') {
          e.preventDefault();
          togglePlay();
        }
      });
    });
  </script>
</head>
<body>
  <canvas id="scene"></canvas>
  <div id="controls">
    <button id="playPause" aria-label="Play or pause whale song">Play</button>
  </div>
  <svg id="whale" viewBox="0 0 100 50" aria-hidden="true">
    <path d="M2 25Q20 5 50 15T98 25Q80 35 50 30T2 25Z"/>
  </svg>
  <noscript>
    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgNTAiPjxwYXRoIGZpbGw9ImJsYWNrIiBkPSJNMiAyNVEyMCA1IDUwIDE1VDk4IDI1UTgwIDM1IDUwIDMwVDIgMjVaIi8+PC9zdmc+" alt="Whale">
  </noscript>
  <script src="scripts/keyboard_nav.js"></script>
</body>
</html>
